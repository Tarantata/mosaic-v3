services:
  # === FRONTEND (Next.js) ===
  app:
    build:
      context: ./app
      dockerfile: Dockerfile
    container_name: mosaic-app
    ports:
      - '3000:3000'
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/api/health"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s  
    environment:
      - NODE_ENV=development
      - GATEWAY_URL=http://gateway:9080
      - CHOKIDAR_USEPOLLING=true
      - WATCHPACK_POLLING=true
    depends_on:
      - gateway
    volumes:
      - ./app:/usr/src/app
      - /usr/src/app/node_modules
    command: npm run dev -- -H 0.0.0.0 -p 3000

  # === GATEWAY (Express) ===
  gateway:
    build:
      context: ./gateway
      dockerfile: Dockerfile
    container_name: mosaic-gateway
    environment:
      - PORT=9080
      - WORKER_CLUSTER_URL=http://color-cluster:8082
      - WORKER_CELLS_URL=http://cell-mapper:8083
      - NODE_ENV=development
    depends_on:
      - color-cluster
      - cell-mapper
    volumes:
      - ./gateway:/usr/src/app
      - /usr/src/app/node_modules
    command: npm run dev

  # === COLOR CLUSTER WORKER ===
  color-cluster:
    build:
      context: ./workers/color-cluster
      dockerfile: Dockerfile
    container_name: mosaic-color-cluster
    ports:
      - '18082:8082' # внешний порт на хосте → внутренний в контейнере
    environment:
      - PORT=8082
      - NODE_ENV=development
    volumes:
      - ./workers/color-cluster:/usr/src/app
      - /usr/src/app/node_modules
    command: npm run dev

  # === CELL MAPPER WORKER ===
  cell-mapper:
    build:
      context: ./workers/cell-mapper
      dockerfile: Dockerfile
    container_name: mosaic-cell-mapper
    ports:
      - '18083:8083'
    environment:
      - PORT=8083
      - NODE_ENV=development
    volumes:
      - ./workers/cell-mapper:/usr/src/app
      - /usr/src/app/node_modules
    command: npm run dev

  # === DATABASE (MongoDB) ===
  mongo:
    image: mongo:7
    container_name: mosaic-mongo
    restart: unless-stopped
    ports:
      - '27017:27017'
    volumes:
      - mongo_data:/data/db

  # === IMAGE LOADER ===
  image-loader:
    profiles: ["block4"]  
    build: ./services/image-loader
    container_name: mosaic-image-loader
    environment:
      - INTERNAL_GALLERY_DIR=/internal-gallery
      - SERVICE_NAME=image-loader
      - PORT=3001
      - MONGO_URL=mongodb://mongo:27017/mosaic
      - SCALER_URL=http://scaler:3002
      - DATA_DIR=/data/images
      - THUMB_DIR=/data/thumbs
    depends_on:
      - mongo
    ports:
      - '3001:3001'
    volumes:
      - ./data/images:/data/images
      - ./data/thumbs:/data/thumbs
      - ./internal-gallery:/app/public/internal-gallery 
      - ./services/image-loader/public:/app/public

  # === SCALER ===
  scaler:
    profiles: ["block4"]  
    build:
      context: ./services/scaler
    container_name: mosaic-scaler
    environment:
      - SERVICE_NAME=scaler
      - PORT=3002
      - IMAGE_LOADER_URL=http://image-loader:3001
    depends_on:
      - image-loader
    ports:
      - '3002:3002'

volumes:
  mongo_data:
